define(["jquery"],function(_){return{initialise:function(){_(document).ready(function(){var e,i=_("#region-main"),t=_("#add_notification_wrapper_id"),s={save:"Save",update:"Update",req:"Required...",preview:"Preview",title:"Title",message:"Message"},p=(i.on("click",".notifications_table tr > td > form > button[type=submit]",function(e){e.preventDefault();var f={call:"ajax",purpose:"",tableaction:"",blockid:""},e=_(this).closest("form").attr("data-edit"),i=_(this).closest("form").attr("data-delete"),e=(f.blockid=_(this).closest("form").find("[name=blockid]")[0].value,d(),void 0!==e&&!1!==e?(f.purpose="edit",f.tableaction=e,(e=_("#add_notification_save")).addClass("update"),e.val(s.update)):void 0!==i&&!1!==i&&(f.purpose="delete",f.tableaction=i),M.cfg.wwwroot+"/blocks/advnotifications/pages/process.php?sesskey="+M.cfg.sesskey);_.post(e,f).fail(function(){console.error("No 'manage' response received.")}).done(function(e){if(e=JSON.parse(e),0<parseInt(e.done,10))_("#tr"+f.purpose+e.done).closest("tr").fadeOut(250,function(){_(this).remove(),u(),v()});else if("edit"===f.purpose){for(var i in e)if(e.hasOwnProperty(i)){if("id"===i&&(l=_("#add_notification_form"),_("#add_notification_id").remove(),l.prepend('<input type="hidden" id="add_notification_id" name="id" value="'+e[i]+'"/>'),_("#add_notification_purpose").val("update")),1!=e.global){if(_(".zone-block").css("display","none"),_(".diet-block").css("display","none"),_(".school-block").css("display","none"),_("#organiation-hirarchy").removeAttr("style"),null!==e.districtid){_("#add_notification_districts option:selected").each(function(){_(this).removeAttr("selected")}),_("#add_notification_districts").removeAttr("selected");for(var t=e.districtid.split(","),o=0;o<t.length;o++)_('#add_notification_districts option[value="'+t[o]+'"]').attr("selected","selected")}if(null!==e.zoneid){_("#add_notification_zones option:selected").each(function(){_(this).removeAttr("selected")}),_(".zone-block").removeAttr("style");for(var n=e.zoneid.split(","),a=0;a<n.length;a++)_('#add_notification_zones option[value="'+n[a]+'"]').attr("selected","selected")}if(null!==e.dietid){_("#add_notification_diet option:selected").each(function(){_(this).removeAttr("selected")}),_(".diet-block").removeAttr("style");for(var s=e.dietid.split(","),d=0;d<s.length;d++)_('#add_notification_diet option[value="'+s[d]+'"]').attr("selected","selected")}if(null!==e.schoolid){_("#add_notification_school option:selected").each(function(){_(this).removeAttr("selected")}),_(".school-block").removeAttr("style");for(var r=e.schoolid.split(","),c=0;c<r.length;c++)_('#add_notification_school option[value="'+r[c]+'"]').attr("selected","selected")}}else _("#organiation-hirarchy").css("display","none");var l=_("#add_notification_wrapper_id").find("#add_notification_"+i);"enabled"!==i&&"global"!==i&&"dismissible"!==i&&"aicon"!==i||1!=e[i]?"enabled"!==i&&"global"!==i&&"dismissible"!==i&&"aicon"!==i||0!=e[i]?l.val(e[i]):l.prop("checked",!1):l.prop("checked",!0)}p()}})}),i.on("click",".notifications_restore_table tr > td > form > button[type=submit]",function(e){e.preventDefault();var i={call:"ajax",purpose:"",tableaction:"",blockid:""},e=_(this).closest("form").attr("data-restore"),t=_(this).closest("form").attr("data-permdelete"),e=(i.blockid=_(this).closest("form").find("[name=blockid]")[0].value,void 0!==e&&!1!==e?(i.purpose="restore",i.tableaction=e):void 0!==t&&!1!==t&&(i.purpose="permdelete",i.tableaction=t),M.cfg.wwwroot+"/blocks/advnotifications/pages/process.php?sesskey="+M.cfg.sesskey);_.post(e,i).fail(function(){console.error("No 'restore/permdelete' response received.")}).done(function(e){e=JSON.parse(e),0<parseInt(e.done,10)&&_("#tr"+i.purpose+e.done).closest("tr").fadeOut(250,function(){_(this).remove()})})}),t.on("click","#add_notification_cancel",function(e){e.preventDefault(),u()}),i.on("submit","#add_notification_form",function(e){e.preventDefault();var i,n=_("#add_notification_status"),a=_("#add_notification_form");d(),o()&&(n.show(),e=_(this).serialize(),i=M.cfg.wwwroot+"/blocks/advnotifications/pages/process.php",_.post(i,e).fail(function(e){console.error("No 'add' response received.");var i,t,o=e.responseJSON.error;for(i in o)o.hasOwnProperty(i)&&((t=a.find("select[name="+o[i]+"]")).addClass("requiredfield"),_('<strong class="requiredfield"><em>'+s.req+"</em></strong>").insertAfter(t[0].nextSibling));n.hide()}).done(function(){n.find(".saving").hide(),n.find(".done").show(),u(),setTimeout(function(){n.fadeOut(function(){n.find(".done").hide(),n.find(".saving").show()})},1500),_("#advnotifications_table_wrapper").load("# #advnotifications_table_wrapper > *")}))}),t.on("input propertychange paste","#add_notification_title, #add_notification_message",function(){p()}),_("#add_notification_type").on("change",function(){p()}),_("#add_notification_dismissible").on("change",function(){p()}),_("#add_notification_aicon").on("change",function(){p()}),function(){var e=t.find("#add_notification_title"),e=(0<e.val().length?t.find(".preview-title")[0].innerHTML=e.val():t.find(".preview-title")[0].innerHTML=s.title,t.find("#add_notification_message")),e=(0<e.val().length?t.find(".preview-message")[0].innerHTML=e.val():t.find(".preview-message")[0].innerHTML=s.message,_("#add_notification_type").val()),i=_("#add_notification_wrapper_id .preview-alert");i.removeClass("alert-info alert-success alert-danger alert-warning announcement"),"announcement"===e&&(i.addClass(e),e="info"),i.addClass("alert-"+(e="info"!==e&&"success"!==e&&"warning"!==e&&"danger"!==e?"info":e)),_(".preview-aicon").find("> img").attr("src",M.util.image_url(e,"block_advnotifications")),_("#add_notification_dismissible")[0].checked?(_(".preview-alert-dismissible").show(),i.addClass("dismissible")):(_(".preview-alert-dismissible").hide(),i.removeClass("dismissible")),_("#add_notification_aicon")[0].checked?(_(".preview-aicon").show(),i.addClass("aicon")):(_(".preview-aicon").hide(),i.removeClass("aicon"))}),v=function(){var e=_("#notification_preview_wrapper"),i='<div id="notification_preview_wrapper"><strong>'+s.preview+'</strong><br><div class="alert alert-info preview-alert"><div class="preview-aicon" style="display: none;"><img src="'+M.util.image_url("info","block_advnotifications")+'" /></div><strong class="preview-title">'+s.title+'</strong> <div class="preview-message">'+s.message+'</div> <div class="preview-alert-dismissible" style="display: none;"><strong>&times;</strong></div></div></div>';0<e.length?(e.remove(),_(i).prependTo(_(t))):_(i).prependTo(_(t)).hide().slideDown()},o=function(){var e,i=_("#add_notification_form select option:selected:disabled");for(e in i)if(i.hasOwnProperty(e)&&_(i[e]).prop("disabled"))return _(i[e]).closest("select").addClass("requiredfield"),_('<strong class="requiredfield"><em>'+s.req+"</em></strong>").insertAfter(_(i[e]).closest("select")[0].nextSibling),!1;return!0},d=function(){_("select.requiredfield").removeClass("requiredfield"),_("strong.requiredfield").remove()},u=function(){_("#add_notification_form")[0].reset(),d(),v(),_("#organiation-hirarchy").css("display","none");var e=_("#add_notification_save");e.removeClass("update"),_("#add_notification_id").remove(),_("#add_notification_purpose").val("add"),e.val(s.save)};i={call:"ajax",purpose:"strings"},e=M.cfg.wwwroot+"/blocks/advnotifications/pages/process.php?sesskey="+M.cfg.sesskey,_.post(e,i).fail(function(){console.error("No 'strings' response received.")}).done(function(e){s=e}).always(function(){v()}),_("#add_notification_form").append('<input type="hidden" id="add_notification_call" name="call" value="ajax"/>')})}}});